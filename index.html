<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DigiKipp – 7 Bilder Demo</title>

  <style>
    :root{
      --violett: rgb(164, 27, 133);
      --blau:    rgb(0, 107, 179);
      --gruen:   rgb(0, 166, 82);
      --orange:  rgb(249, 150, 30);

      --cell-gap: 0px;
      --cell-radius: 0px;

      --floor: #7a4a34;

      --cube-wood-base: #d7c2a4;
      --cube-wood-deep: #c9b08f;
      --cube-wood-warm: rgba(155, 70, 110, 0.10);
      --cube-wood-gold: rgba(249, 150, 30, 0.10);

      --w1-innerframe: rgba(122, 74, 52, 1);

      --slot-border: rgba(0,0,0,0.55);
      --slot-border-w: 2px;
      --slot-fill: #ead7be;

      --box-black: #000;
      --box-border: 4px;
      --box-radius: 0px;

      --btn-bg: #ead7be;
      --btn-text: #2a160c;
      --btn-border: rgba(0,0,0,0.35);

      --ui-panel-bg: #4a2418;   /* dunkel-rotbraun */
      --ui-text: #ead7be;       /* hellbeige */

      --kippstrip-h: auto;

      /* ✅ UI-Cell (= Boardbreite/8) wird per JS gesetzt */
      --ui-cell: 60px;

      --rotSign: 1;
      --rot: 0deg;
    }

    html, body { height: 100%; }

    /* ✅ Tischfläche */
    body{
      margin:0;
      display:flex;
      justify-content:center;

      background:
        radial-gradient(120% 80% at 18% 12%, rgba(255,255,255,0.10), rgba(255,255,255,0) 60%),
        radial-gradient(120% 90% at 80% 88%, rgba(0,0,0,0.35), rgba(0,0,0,0) 60%),
        repeating-linear-gradient(
          92deg,
          rgba(0,0,0,0.10) 0px,
          rgba(0,0,0,0.10) 6px,
          rgba(255,255,255,0.03) 6px,
          rgba(255,255,255,0.03) 16px
        ),
        repeating-linear-gradient(
          18deg,
          rgba(0,0,0,0.10) 0px,
          rgba(0,0,0,0.10) 14px,
          rgba(255,255,255,0.03) 14px,
          rgba(255,255,255,0.03) 30px
        ),
        linear-gradient(180deg, #5b3626, #4c2b1f 55%, #3e2218);

      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    .stage{
      width: min(94vw, 688px);
      margin-top: 0;
      padding-top: 8px;
      padding-bottom: 2vh;
      display:flex;
      flex-direction: column;
      gap: 12px;
      justify-content:flex-start;
      align-items:center;

      background: var(--ui-panel-bg);
      min-height: 100vh;
      box-sizing: border-box;
    }

    /* ===== HEADER ===== */
    .titleRow{
      width: 100%;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      user-select:none;
      margin-bottom: 2px;
      padding: 0 10px;
      box-sizing: border-box;
    }

    .navBtn{
      width: 46px;
      height: 46px;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      cursor: pointer;

      background: transparent;
      border: 2px solid var(--ui-text);
      box-shadow: none;
      padding:0;
    }
    .navBtn svg{
      width: 28px;
      height: 28px;
      stroke: var(--ui-text);
      stroke-width: 5;
      fill: none;
      stroke-linecap: square;
      stroke-linejoin: miter;
    }
    .navBtn:active{
      transform: scale(0.98);
      filter: brightness(1.03);
    }

    .titleMain{
      flex: 1 1 auto;
      display:flex;
      justify-content:center;
      align-items:center;
      min-width: 0;
    }
    .titleMain h1{
      margin: 0;
      padding: 0;
      font-weight: 1000;
      letter-spacing: 0.08em;
      font-size: clamp(22px, 6.0vmin, 44px);
      color: var(--ui-text);
      text-shadow:
        0 1px 0 rgba(0,0,0,0.28),
        0 10px 18px rgba(0,0,0,0.18);
      line-height: 1;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    /* ===== BOX SHELL ===== */
    .boxShell{
      width: 100%;
      box-sizing: border-box;
      background: transparent;
      border: 0;
      border-radius: var(--box-radius);
      box-shadow: none;
      overflow: visible;
      display:flex;
      flex-direction: column;
      gap: 0;
      position: relative; /* ✅ für Nord/Süd Schatten */
    }

    .boxShell::before,
    .boxShell::after{
      content:"";
      position:absolute;
      left: 0;
      width: 100%;
      height: 18px;
      pointer-events:none;
      z-index: 50;
      opacity: 0.95;
    }
    .boxShell::before{
      top: -12px;
      background: linear-gradient(to bottom, rgba(0,0,0,0.45), rgba(0,0,0,0.00));
      filter: blur(0.2px);
    }
    .boxShell::after{
      bottom: -12px;
      background: linear-gradient(to top, rgba(0,0,0,0.45), rgba(0,0,0,0.00));
      filter: blur(0.2px);
    }

    .board{
      position:relative;
      width: 100%;
      height: auto;
      aspect-ratio: 1 / 1;
      box-sizing: border-box;
      background: var(--box-black);
      border: 0;
      border-radius: 0;
      overflow: visible;

      box-shadow:
        10px 18px 42px rgba(0,0,0,0.55),
        3px 6px 16px rgba(0,0,0,0.35);

      --cell: calc((100% - 7 * var(--cell-gap)) / 8);
      --step: calc(var(--cell) + var(--cell-gap));
    }

    .grid{
      position:absolute;
      inset:0;
      display:grid;
      grid-template-columns: repeat(8, 1fr);
      grid-template-rows: repeat(8, 1fr);
      gap: var(--cell-gap);
      pointer-events: none;
      z-index: 1;
    }

    .cell{
      background: var(--box-black);
      border-radius: var(--cell-radius);
      box-sizing: border-box;
      box-shadow: none;
      position: relative;
    }

    .c-orange{ background: var(--orange); }
    .c-gruen { background: var(--gruen);  }
    .c-violett{ background: var(--violett); }
    .c-blau  { background: var(--blau);   }

    .cell.colorCell{
      box-shadow:
        inset 0 0 0 2px #000,
        0 0 0 1px rgba(0,0,0,0.25);
    }

    /* ===== Target Zahl auf farbigen Feldern ===== */
    @keyframes targetBreath{
      0%,100%{ transform: translate(-50%, -50%) rotate(var(--trot, 0deg)) scale(1); opacity: 0.95; }
      50%    { transform: translate(-50%, -50%) rotate(var(--trot, 0deg)) scale(1.10); opacity: 1; }
    }
    .targetBadge{
      position:absolute;
      left:50%;
      top:50%;
      font-weight: 900;
      font-size: clamp(18px, 8vmin, 36px);
      color: rgba(0,0,0,0.92);
      text-shadow: 0 1px 0 rgba(255,255,255,0.35);
      line-height: 1;
      letter-spacing: 0.01em;
      pointer-events:none;
      z-index: 3;
      animation: targetBreath 1.25s ease-in-out infinite;
      transform-origin: 50% 50%;
      will-change: transform, opacity;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .trot-top    { --trot: 0deg; }
    .trot-bottom { --trot: 180deg; }
    .trot-left   { --trot: -90deg; }
    .trot-right  { --trot: 90deg; }

    /* ===== Overlay "ZWEITES KIPPZIEL" (wird NICHT mehr verwendet) ===== */
    .goalOverlay{ display:none !important; }

    /* ===== FLOOR ===== */
    .floor{
      position:absolute;
      left: var(--step);
      top:  var(--step);
      width: calc(6 * var(--cell) + 5 * var(--cell-gap));
      height: calc(6 * var(--cell) + 5 * var(--cell-gap));
      border-radius: 0;
      z-index: 2;
      pointer-events: none;

      background-image: url("Box.png");
      background-repeat: no-repeat;
      background-position: center;
      background-size: 100% 100%;

      box-shadow:
        inset 18px 18px 34px rgba(255,255,255,0.10),
        inset -22px -22px 44px rgba(0,0,0,0.28),
        inset -26px 0 40px rgba(0,0,0,0.26),
        inset  26px 0 40px rgba(0,0,0,0.26),
        inset  0 -26px 40px rgba(0,0,0,0.30),
        inset  0  26px 40px rgba(0,0,0,0.30);
    }

    .ball{
      position:absolute;
      left: calc(var(--step) + ( (6 * var(--cell) + 5 * var(--cell-gap)) / 2 ));
      top:  calc(var(--step) + ( (6 * var(--cell) + 5 * var(--cell-gap)) / 2 ));
      width: calc(var(--cell) * 0.55);
      height: calc(var(--cell) * 0.55);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      background:
        radial-gradient(circle at 30% 28%, rgba(255,255,255,0.55), rgba(255,255,255,0.0) 45%),
        radial-gradient(circle at 55% 60%, rgba(0,0,0,0.18), rgba(0,0,0,0.00) 55%),
        radial-gradient(circle at 50% 55%, #d6b996, #b88d63 70%);
      box-shadow: 0 3px 6px rgba(0,0,0,0.28);
      z-index: 3;
      pointer-events: none;
    }

    .wFaceGroup,
    .kipGroup{
      position:absolute;
      inset:0;
      z-index: 4;
      pointer-events:none;

      --pivot-x: calc(4 * var(--step));
      --pivot-y: calc(4 * var(--step));

      transform:
        translate(var(--pivot-x), var(--pivot-y))
        rotate(var(--rot))
        translate(calc(-1 * var(--pivot-x)), calc(-1 * var(--pivot-y)));
      transform-origin: 0 0;
    }

    .hidden{ display:none !important; }

    .cubeShadow{
      position:absolute;
      left: calc(1 * var(--step));
      top:  calc(1 * var(--step));
      width: calc(3 * var(--cell) + 2 * var(--cell-gap));
      height: calc(3 * var(--cell) + 2 * var(--cell-gap));
      z-index: 1;
      background: transparent;
      box-shadow:
        0 22px 26px rgba(0,0,0,0.32),
        0 10px 16px rgba(0,0,0,0.18);
    }

    .cubeFace{
      position:absolute;
      width: calc(3 * var(--cell) + 2 * var(--cell-gap));
      height: calc(3 * var(--cell) + 2 * var(--cell-gap));
      box-sizing: border-box;
      border-radius: 0;
      background:
        radial-gradient(120% 90% at 15% 15%, var(--cube-wood-gold), transparent 55%),
        radial-gradient(120% 90% at 25% 25%, var(--cube-wood-warm), transparent 60%),
        repeating-linear-gradient(
          20deg,
          rgba(0,0,0,0.02) 0px,
          rgba(0,0,0,0.02) 10px,
          rgba(255,255,255,0.02) 10px,
          rgba(255,255,255,0.02) 18px
        ),
        linear-gradient(135deg, rgba(255,255,255,0.16), rgba(0,0,0,0.08)),
        linear-gradient(180deg, var(--cube-wood-base), var(--cube-wood-deep));
      box-shadow:
        inset 0 0 0 2px var(--w1-innerframe),
        0 0 0 1px rgba(255,255,255,0.08) inset;
      z-index: 2;
      left: calc(1 * var(--step));
      top:  calc(1 * var(--step));
    }

    .slot{
      position:absolute;
      width: var(--cell);
      height: var(--cell);
      box-sizing: border-box;
      background:
        linear-gradient(135deg, rgba(255,255,255,0.14), rgba(0,0,0,0.05)),
        var(--slot-fill);
      border: var(--slot-border-w) solid var(--slot-border);
      border-radius: var(--cell-radius);
      z-index: 7;
      box-shadow:
        1px 1px 0 rgba(255,255,255,0.18) inset,
        -1px -1px 0 rgba(0,0,0,0.08) inset,
        0 3px 5px rgba(0,0,0,0.22),
        2px 2px 3px -1px rgba(0,0,0,0.20);
    }

    .slot .num{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      z-index: 9;
    }

    .slot .num > span{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      color: #111;
      font-size: clamp(18px, 8vmin, 36px);
      text-shadow: 0 1px 0 rgba(255,255,255,0.35);
      transform: rotate(var(--num-rot, 0deg));
      transform-origin: 50% 50%;
      position: relative;
      line-height: 1;
    }

    .read-south { --num-rot: calc(var(--rotSign) * 0deg); }
    .read-west  { --num-rot: calc(var(--rotSign) * 90deg); }
    .read-east  { --num-rot: calc(var(--rotSign) * -90deg); }
    .read-north { --num-rot: calc(var(--rotSign) * 180deg); }

    .s-3b{ left: calc(1 * var(--step)); top: calc(2 * var(--step)); }
    .s-4b{ left: calc(1 * var(--step)); top: calc(3 * var(--step)); }
    .s-2c{ left: calc(2 * var(--step)); top: calc(1 * var(--step)); }
    .s-2d{ left: calc(3 * var(--step)); top: calc(1 * var(--step)); }

    .kipScale{
      position:absolute;
      inset:0;
      --pivot-x: calc(4 * var(--step));
      --pivot-y: calc(4 * var(--step));
      transform:
        translate(var(--pivot-x), var(--pivot-y))
        scaleX(0.6666667)
        translate(calc(-1 * var(--pivot-x)), calc(-1 * var(--pivot-y)));
      transform-origin: 0 0;
    }

    .kipShadow{
      position:absolute;
      left: calc(1 * var(--step));
      top:  calc(1 * var(--step));
      width: calc(6 * var(--cell) + 5 * var(--cell-gap));
      height: calc(3 * var(--cell) + 2 * var(--cell-gap));
      background: transparent;
      z-index: 1;
      box-shadow:
        0 22px 26px rgba(0,0,0,0.32),
        0 10px 16px rgba(0,0,0,0.18);
    }

    .kipEdgeCore{
      position:absolute;
      left: calc(4 * var(--step));
      top:  calc(1 * var(--step));
      width: 6px;
      height: calc(3 * var(--cell) + 2 * var(--cell-gap));
      transform: translateX(-50%);
      background: linear-gradient(90deg, rgba(0,0,0,0.00), rgba(0,0,0,0.28), rgba(0,0,0,0.00));
      z-index: 1;
      opacity: 0.95;
    }

    .kipFaceQ0{ left: calc(1 * var(--step)); top: calc(1 * var(--step)); }
    .kipFaceQ1{ left: calc(4 * var(--step)); top: calc(1 * var(--step)); }

    .k-4d{ left: calc(3 * var(--step)); top: calc(3 * var(--step)); }
    .k-3d{ left: calc(3 * var(--step)); top: calc(2 * var(--step)); }
    .k-2b{ left: calc(1 * var(--step)); top: calc(1 * var(--step)); }
    .k-2c{ left: calc(2 * var(--step)); top: calc(1 * var(--step)); }

    .k-3e{ left: calc(4 * var(--step)); top: calc(2 * var(--step)); }
    .k-4e{ left: calc(4 * var(--step)); top: calc(3 * var(--step)); }
    .k-2f{ left: calc(5 * var(--step)); top: calc(1 * var(--step)); }
    .k-2g{ left: calc(6 * var(--step)); top: calc(1 * var(--step)); }

    /* ===== Konsole-Block ===== */
    .kippspeedBlock{
      width: 100%;
      height: var(--kippstrip-h);
      background: var(--box-black);
      user-select:none;
      display:flex;
      flex-direction: column;
      justify-content: center;
      gap: 6px;
      position: relative;
      padding-top: 6px;
      padding-bottom: 6px;
    }

    .modeBlock{ width:100%; box-sizing:border-box; }
    .modeBlock.hidden{ display:none !important; }

    .kippspeedTop{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      padding: 0 12px;
    }

    .kippspeedLabel{
      font-weight: 1000;
      letter-spacing: 0.10em;
      text-transform: uppercase;
      color: var(--ui-text);
      text-shadow: 0 1px 0 rgba(0,0,0,0.35);
      font-size: 16px;
      line-height: 1.05;
      text-align: center;
      user-select:none;
      white-space: nowrap;
    }

    .squareBtn{
      width: 44px;
      height: 44px;
      border-radius: 0;
      border: 2px solid rgba(0,0,0,0.55);
      background:
        linear-gradient(180deg, rgba(255,255,255,0.14), rgba(0,0,0,0.05)),
        var(--btn-bg);
      box-shadow:
        0 18px 22px rgba(0,0,0,0.35),
        0 8px 14px rgba(0,0,0,0.22),
        0 0 0 1px rgba(255,255,255,0.18) inset;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      cursor: pointer;
    }
    .squareBtn:active{
      transform: scale(0.985);
      filter: brightness(0.98);
    }

    .playIcon{
      width: 0;
      height: 0;
      border-top: 11px solid transparent;
      border-bottom: 11px solid transparent;
      border-left: 18px solid #7a3f2b;
      filter: drop-shadow(0 1px 0 rgba(255,255,255,0.25));
      transform: translateX(1px);
    }

    .pauseIcon{
      width: 18px;
      height: 22px;
      position: relative;
      filter: drop-shadow(0 1px 0 rgba(255,255,255,0.25));
    }
    .pauseIcon::before,
    .pauseIcon::after{
      content:"";
      position:absolute;
      top:0;
      width: 6px;
      height: 22px;
      background: #7a3f2b;
      border-radius: 1px;
    }
    .pauseIcon::before{ left: 0; }
    .pauseIcon::after { right: 0; }

    .okText{
      font-weight: 1000;
      letter-spacing: 0.06em;
      color: #7a3f2b;
      text-shadow: 0 1px 0 rgba(255,255,255,0.35);
      font-size: 16px;
      line-height: 1;
    }

    .sliderRow{
      display:flex;
      align-items:center;
      gap: 14px;
      padding: 0 12px;
    }

    .speedIcon{
      width: clamp(44px, 10vmin, 62px);
      height: clamp(44px, 10vmin, 62px);
      opacity: 0.98;
      flex: 0 0 auto;
      filter:
        brightness(0) saturate(100%)
        invert(90%) sepia(16%) saturate(330%)
        hue-rotate(355deg) brightness(105%) contrast(95%)
        drop-shadow(0 1px 0 rgba(0,0,0,0.35))
        drop-shadow(0 2px 6px rgba(0,0,0,0.25));
    }

    .speedScale{
      margin: 0 12px;
      padding-left: calc(clamp(44px, 10vmin, 62px) + 14px);
      padding-right: calc(clamp(44px, 10vmin, 62px) + 14px);
      display:flex;
      justify-content: space-between;
      color: var(--ui-text);
      font-weight: 1000;
      letter-spacing: 0.08em;
      font-size: 14px;
      line-height: 1;
      user-select:none;
      text-shadow: 0 1px 0 rgba(0,0,0,0.35);
      transform: translateY(-2px);
    }

    input[type="range"]{
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: var(--ui-panel-bg);
      outline: none;
      border: 1px solid #000;
      box-shadow:
        0 0 0 1px rgba(255,255,255,0.10) inset,
        0 1px 0 rgba(0,0,0,0.35) inset;
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance: none;
      appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 6px;
      background: var(--btn-bg);
      border: 2px solid rgba(0,0,0,0.35);
      box-shadow:
        0 8px 14px rgba(0,0,0,0.22),
        0 0 0 1px rgba(255,255,255,0.18) inset;
      cursor: pointer;
    }

    /* ===== Game Console ===== */
    .gameConsole{
      width:100%;
      height:100%;
      padding: 8px 12px;
      box-sizing:border-box;
      display:flex;
      flex-direction: column;
      justify-content: space-between;
      gap: 8px;
      position: relative;
    }

    .previewBlock{
      margin-top: 42px;
      display:flex;
      flex-direction: column;
      gap: 8px;
    }
    .previewHint{
      text-align:center;
      font-weight: 1000;
      letter-spacing: 0.10em;
      text-transform: uppercase;
      color: var(--ui-text);
      text-shadow: 0 1px 0 rgba(0,0,0,0.35);
      font-size: clamp(14px, 5.2vmin, 20px);
      user-select:none;
    }

    /* ===== Kipp-Buttons: 50% kleiner ===== */
    .miniBtn{
      flex: 1 1 0;
      border: 1px solid rgba(0,0,0,0.35);
      background: rgba(234,215,190,0.95);
      color: #2a160c;
      font-weight: 1000;

      /* ✅ ca. 50% kleiner als vorher */
      font-size: clamp(14px, 5.5vmin, 22px);
      line-height: 1;
      padding: 7px 0;
      border-radius: 10px;

      cursor: pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      box-shadow:
        0 10px 18px rgba(0,0,0,0.20),
        0 0 0 1px rgba(255,255,255,0.12) inset;
    }
    .miniBtn:active{ transform: translateY(1px) scale(0.99); }

    .miniBtn.sel{
      background: var(--ui-panel-bg);
      color: var(--ui-text);
      border-color: rgba(0,0,0,0.55);
    }

    .miniBtn[disabled]{
      opacity: 0.55;
      cursor: default;
      filter: grayscale(0.1);
    }

    /* (Rest bleibt wie bei dir) */
    .scorePanel{ width: 100%; height: calc(var(--ui-cell) * 2); background: var(--ui-panel-bg); position: relative; user-select:none; overflow: hidden; border: 0; box-sizing: border-box; box-shadow: none; }
    .scorePanel.underConsole{ margin-top: 0; }
    .scoreAnchor{ position:absolute; right: 12px; top: 50%; transform: translateY(-50%); display:flex; flex-direction: column; align-items: flex-end; justify-content: center; gap: 2px; pointer-events: none; z-index: 5; text-align: right; }
    .gcPoints{ font-weight: 1000; color: var(--ui-text); text-shadow: 0 1px 0 rgba(0,0,0,0.35); font-size: 34px; line-height: 0.95; letter-spacing: 0.02em; font-variant-numeric: tabular-nums; white-space: nowrap; }
    .gcHi{ display:none; }
    .kippBilanzBtn{ position:absolute; left: 12px; top: 50%; transform: translateY(-50%); width: calc(33.333% - 8px); height: calc(var(--ui-cell) * 0.85); border-radius: 12px; border: 1px solid rgba(0,0,0,0.35); background: var(--btn-bg); color: var(--btn-text); font-weight: 1000; letter-spacing: 0.06em; text-transform: none; cursor: pointer; box-shadow: 0 10px 18px rgba(0,0,0,0.25), 0 0 0 1px rgba(255,255,255,0.15) inset; user-select: none; -webkit-tap-highlight-color: transparent; display:flex; align-items:center; justify-content:center; padding: 0 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; z-index: 6; }
    .kippBilanzBtn:active{ transform: translateY(-50%) translateY(1px) scale(0.99); filter: brightness(0.97); }

    .gcBottom{ display:flex; flex-direction: column; gap: 8px; }
    .gcRow{ display:flex; gap: 8px; justify-content: space-between; align-items:center; }
    .gcBtn{ flex: 1 1 0; border: 1px solid rgba(0,0,0,0.35); background: var(--btn-bg); color: var(--btn-text); font-weight: 1000; letter-spacing: 0.06em; text-transform: uppercase; padding: 12px 12px; border-radius: 12px; cursor: pointer; box-shadow: 0 10px 18px rgba(0,0,0,0.25), 0 0 0 1px rgba(255,255,255,0.15) inset; user-select: none; -webkit-tap-highlight-color: transparent; }
    .gcBtn:active{ transform: translateY(1px) scale(0.99); filter: brightness(0.97); }

    #decisionPanel{ padding: 0 12px; box-sizing: border-box; transform: translateY(-20px); } /* ✅ 20 px weiter rauf (gen Norden) */

    /* ✅ Schreibweise ist wichtig -> KEIN uppercase erzwingen */
    .kippCountTitle{
      font-weight: 1000;
      letter-spacing: 0.10em;
      color: var(--ui-text);
      text-shadow: 0 1px 0 rgba(0,0,0,0.35);
      font-size: clamp(18px, 5.6vmin, 34px);
      line-height: 0.95;
      text-align: left;
      user-select:none;
      margin-top: 6px;
      margin-bottom: 10px;
      text-transform: none;
    }
    .kippStatus{
      font-weight: 1000;
      letter-spacing: 0.08em;
      color: var(--ui-text);
      text-shadow: 0 1px 0 rgba(0,0,0,0.35);
      font-size: clamp(12px, 3.9vmin, 16px);
      line-height: 1.05;
      margin-bottom: 10px;
      user-select:none;
      text-transform: none;
    }

    /* ✅ "...KIPP-ZIEL" in random Zielfarbe */
    .kippGoalWord{
      font-weight: 1000;
    }

    @keyframes blinkSoft{ 0%, 100% { opacity: 1; } 50% { opacity: 0.35; } }
    @keyframes pulseSoft{ 0%, 100% { transform: scale(1); } 50% { transform: scale(1.06); } }

    .attnSpeed .kippspeedLabel{ animation: blinkSoft 1.4s ease-in-out infinite; }
    .attnSpeed .speedIcon{ animation: pulseSoft 1.0s ease-in-out infinite; }
    .attnSpeed input[type="range"]::-webkit-slider-thumb{ animation: pulseSoft 1.0s ease-in-out infinite; }
    .attnPlay #btnPlay{ animation: blinkSoft 0.9s ease-in-out infinite; }
    .attnSet .gcBtn.set{ animation: blinkSoft 0.85s ease-in-out infinite; }

    #decisionPanel.pulseSeq .miniBtn{ animation: pulseSoft 1.15s ease-in-out infinite; }
    #decisionPanel.pulseSeq .miniBtn:nth-child(1){ animation-delay: 0.00s; }
    #decisionPanel.pulseSeq .miniBtn:nth-child(2){ animation-delay: 0.10s; }
    #decisionPanel.pulseSeq .miniBtn:nth-child(3){ animation-delay: 0.20s; }

    #levelPanel{
      width: 100%;
      box-sizing: border-box;
      padding: 0 12px;
      height: 100%;
      display:flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 10px;

      transform: translateY(-6px);

      position: relative;
      z-index: 9999;
    }
    #levelPanel.hidden{ display:none !important; }

    .levelTitle{
      font-weight: 1000;
      letter-spacing: 0.10em;
      text-transform: uppercase;
      color: var(--ui-text);
      text-shadow: 0 1px 0 rgba(0,0,0,0.35);
      text-align:center;
      line-height: 1.05;

      font-size: clamp(14px, 6vmin, 22px);
      max-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      user-select:none;
    }

    .levelRow{
      width: 100%;
      display:flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      max-width: 100%;
    }

    .levelBtn{
      flex: 1 1 0;
      max-width: 33.33%;
      min-width: 0;

      border: 1px solid rgba(0,0,0,0.35);
      background: rgba(234,215,190,0.95);
      color: #2a160c;
      font-weight: 1000;

      font-size: clamp(12px, 4vmin, 18px);
      letter-spacing: 0.04em;
      line-height: 1.05;

      padding: 12px 8px;
      border-radius: 12px;
      cursor: pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      box-shadow:
        0 10px 18px rgba(0,0,0,0.20),
        0 0 0 1px rgba(255,255,255,0.12) inset;

      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .levelBtn:active{
      transform: translateY(1px) scale(0.99);
      filter: brightness(0.97);
    }
  </style>
</head>

<body>
  <div class="stage">

    <div class="titleRow" aria-label="Titelzeile">
      <button id="backBtn" class="navBtn" aria-label="Zurück zur Speed-Einstellung" type="button">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M15 5L8 12l7 7"></path>
        </svg>
      </button>

      <div class="titleMain"><h1>KIPP COLOR</h1></div>

      <button id="exitBtnTop" class="navBtn" aria-label="Spiel beenden" type="button">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M6 6l12 12M18 6L6 18"></path>
        </svg>
      </button>
    </div>

    <div class="boxShell" id="boxShell" aria-label="BoxShell">

      <div class="board" id="board">
        <div class="floor" aria-hidden="true"></div>
        <div id="grid" class="grid" aria-label="8×8 Raster"></div>

        <!-- ✅ Ziel-Overlay (wird NICHT mehr verwendet) -->
        <div id="goalOverlay" class="goalOverlay" aria-hidden="true">
          <div id="goalCard" class="goalCard">
            <div id="goalMain" class="goalMain">ERSTES KIPPZIEL</div>
            <div id="goalSub" class="goalSub">von zehn</div>
          </div>
        </div>

        <div id="wFaceGroup" class="wFaceGroup" aria-label="W Paket">
          <div class="cubeShadow" aria-hidden="true"></div>
          <div class="cubeFace" aria-label="Würfelfläche"></div>

          <div class="slot s-3b read-west"  data-slot="S1"><div class="num"><span></span></div></div>
          <div class="slot s-4b read-west"  data-slot="S2"><div class="num"><span></span></div></div>
          <div class="slot s-2c read-north" data-slot="S3"><div class="num"><span></span></div></div>
          <div class="slot s-2d read-north" data-slot="S4"><div class="num"><span></span></div></div>
        </div>

        <div id="kipGroup" class="kipGroup hidden" aria-label="KIP Gruppe">
          <div class="kipScale">
            <div class="kipShadow" aria-hidden="true"></div>
            <div class="kipEdgeCore" aria-hidden="true"></div>

            <div class="cubeFace kipFaceQ0" aria-label="Würfelfläche Q0"></div>
            <div class="cubeFace kipFaceQ1" aria-label="Würfelfläche Q1"></div>

            <div class="slot k-4d read-east"  data-slot="W2_A"><div class="num"><span></span></div></div>
            <div class="slot k-3d read-east"  data-slot="W2_B"><div class="num"><span></span></div></div>
            <div class="slot k-2b read-north" data-slot="W2_C"><div class="num"><span></span></div></div>
            <div class="slot k-2c read-north" data-slot="W2_D"><div class="num"><span></span></div></div>

            <div class="slot k-3e read-west"  data-slot="W1_1"><div class="num"><span></span></div></div>
            <div class="slot k-4e read-west"  data-slot="W1_2"><div class="num"><span></span></div></div>
            <div class="slot k-2f read-north" data-slot="W1_3"><div class="num"><span></span></div></div>
            <div class="slot k-2g read-north" data-slot="W1_4"><div class="num"><span></span></div></div>
          </div>
        </div>

        <div class="ball" aria-label="Kugel"></div>
      </div>

      <div class="kippspeedBlock attnSpeed" id="kippspeedBlock" aria-label="Konsole">

        <div id="speedMode" class="modeBlock">
          <div class="kippspeedTop">
            <div class="kippspeedLabel" id="kippspeedLabel">KIPP SPEED (KSP)</div>

            <button id="btnPlay" class="squareBtn" aria-label="Demo starten/pausieren" type="button">
              <span id="playGlyph" class="playIcon" aria-hidden="true"></span>
            </button>

            <button id="btnOk" class="squareBtn" aria-label="Geschwindigkeit bestätigen" type="button">
              <span class="okText">OK</span>
            </button>
          </div>

          <div class="sliderRow">
            <img class="speedIcon" src="kippspeed_snail_tight.png" alt="langsam">
            <input id="speedSlider" type="range" min="0" max="9" value="3" step="1" aria-label="Speed Slider">
            <img class="speedIcon" src="kippspeed_hase_tight.png" alt="schnell">
          </div>

          <div class="speedScale" aria-label="Kippspeed Stufen">
            <span>1</span><span>2</span><span>3</span><span>4</span>
          </div>
        </div>

        <div id="gameMode" class="modeBlock hidden">
          <div class="gameConsole">
            <div class="gcBottom" aria-label="Aktionen">

              <div class="previewBlock" aria-label="Vorschau-Block">
                <div id="previewHint" class="previewHint">SCHAU GENAU!</div>
                <button id="btnSetNumbers" class="gcBtn set" type="button">VORSCHAU-KIPPS</button>
              </div>

              <div id="levelPanel" class="hidden" aria-label="Level wählen">
                <div class="levelTitle" id="levelTitle">LEVEL WÄHLEN</div>
                <div class="levelRow" aria-label="Level Buttons">
                  <button id="btnLevelTrainee" class="levelBtn" type="button">Trainee</button>
                  <button id="btnLevelBrainy" class="levelBtn" type="button">Brainy</button>
                  <button id="btnLevelBrain" class="levelBtn" type="button">Brain</button>
                </div>
              </div>

              <div id="decisionPanel" class="hidden">
                <div class="kippCountTitle" id="kippTitle">KIPP Anzahl wählen</div>
                <div class="kippStatus" id="kippStatus">Tippe auf eine Taste</div>

                <!-- ✅ 3 Tasten: 3 / 6 / 9 -->
                <div class="gcRow" aria-label="Kippanzahl">
                  <button class="miniBtn" data-k="3" type="button">3</button>
                  <button class="miniBtn" data-k="6" type="button">6</button>
                  <button class="miniBtn" data-k="9" type="button">9</button>
                </div>
              </div>

            </div>
          </div>
        </div>

      </div>

      <div id="scorePanel" class="scorePanel underConsole hidden" aria-label="Score Panel">
        <button id="btnKippBilanz" class="kippBilanzBtn" type="button" aria-label="KIPP Bilanz">
          KIPP Bilanz
        </button>

        <div class="scoreAnchor">
          <div id="gcPoints" class="gcPoints">P00/80</div>
          <div class="gcHi">Highscore: <span id="gcHi">80</span></div>
        </div>
      </div>

    </div>

  </div>

  <script>
    const boardEl     = document.getElementById("board");
    const grid        = document.getElementById("grid");
    const wFace       = document.getElementById("wFaceGroup");
    const kipGroup    = document.getElementById("kipGroup");
    const speedSlider = document.getElementById("speedSlider");

    const kippspeedBlock = document.getElementById("kippspeedBlock");
    const speedMode   = document.getElementById("speedMode");
    const gameMode    = document.getElementById("gameMode");

    const scorePanel  = document.getElementById("scorePanel");
    const btnKippBilanz = document.getElementById("btnKippBilanz");

    const btnPlay     = document.getElementById("btnPlay");
    const playGlyph   = document.getElementById("playGlyph");
    const btnOk       = document.getElementById("btnOk");

    const backBtn     = document.getElementById("backBtn");
    const exitBtnTop  = document.getElementById("exitBtnTop");

    const btnSetNumbers = document.getElementById("btnSetNumbers");
    const decisionPanel = document.getElementById("decisionPanel");

    const gcPoints    = document.getElementById("gcPoints");
    const gcHi        = document.getElementById("gcHi");

    const levelPanel = document.getElementById("levelPanel");
    const levelTitle = document.getElementById("levelTitle");
    const btnLevelTrainee = document.getElementById("btnLevelTrainee");
    const btnLevelBrainy  = document.getElementById("btnLevelBrainy");
    const btnLevelBrain   = document.getElementById("btnLevelBrain");

    const previewHintEl = document.getElementById("previewHint");

    const kippTitleEl  = document.getElementById("kippTitle");
    const kippStatusEl = document.getElementById("kippStatus");

    const goalOverlayEl = document.getElementById("goalOverlay");
    const goalMainEl    = document.getElementById("goalMain");
    const goalSubEl     = document.getElementById("goalSub");
    const goalCardEl    = document.getElementById("goalCard");

    function sleep(ms){ return new Promise(res => setTimeout(res, ms)); }

    function setBoardSquare(){
      const w = Math.round(boardEl.getBoundingClientRect().width);
      boardEl.style.height = w + "px";
    }

    function setKippspeedStripHeight(){
      const w = Math.round(boardEl.getBoundingClientRect().width);
      const cell = w / 8;
      const h = Math.round(cell * 3);
      document.documentElement.style.setProperty("--kippstrip-h", h + "px");
      document.documentElement.style.setProperty("--ui-cell", Math.round(cell) + "px");
    }

    function getTiming(){
      const v = Number(speedSlider.value || 3);
      const hold = Math.max(520, Math.round(2200 - v * 186));
      // ✅ 50% Zwischenkipp / 100% Vollbild
      const kip = Math.max(160, Math.round(hold * 0.50));
      const wfull = hold;
      return { holdMs: hold, kipMs: kip, wMs: wfull };
    }

    const cols = ["A","B","C","D","E","F","G","H"];
    function key(r, cLetter){ return `${r}${cLetter}`; }

    const colorMap = new Map([
      [key(3,"A"), "c-orange"],
      [key(4,"A"), "c-gruen"],
      [key(5,"A"), "c-violett"],
      [key(6,"A"), "c-blau"],

      [key(8,"C"), "c-gruen"],
      [key(8,"D"), "c-orange"],
      [key(8,"E"), "c-gruen"],
      [key(8,"F"), "c-orange"],

      [key(6,"H"), "c-violett"],
      [key(5,"H"), "c-blau"],
      [key(4,"H"), "c-orange"],
      [key(3,"H"), "c-gruen"],

      [key(1,"F"), "c-blau"],
      [key(1,"E"), "c-violett"],
      [key(1,"D"), "c-blau"],
      [key(1,"C"), "c-violett"],
    ]);

    function buildGridOnce(){
      if (grid.dataset.built === "1") return;
      for(let r=1; r<=8; r++){
        for(let c=0; c<8; c++){
          const cell = document.createElement("div");
          cell.className = "cell";
          const coord = key(r, cols[c]);
          cell.dataset.coord = coord;
          if(colorMap.has(coord)){
            const cls = colorMap.get(coord);
            cell.classList.add(cls);
            cell.classList.add("colorCell");
          }
          grid.appendChild(cell);
        }
      }
      grid.dataset.built = "1";
    }

    function renderNumber(span, n){
      if(!span) return;
      span.textContent = (n === null || n === undefined) ? "" : String(n);
    }

    function getUniqueRandomNumbers(count, min, max){
      const pool = [];
      for(let i=min; i<=max; i++) pool.push(i);
      for(let i=pool.length-1; i>0; i--){
        const j = Math.floor(Math.random() * (i+1));
        [pool[i], pool[j]] = [pool[j], pool[i]];
      }
      return pool.slice(0, count);
    }

    const rotDeg = [0, 90, 180, 270];
    let rotIndex  = 0;
    let faceIndex = 0;

    function setRotationSnap(){
      const deg = rotDeg[rotIndex];
      wFace.style.setProperty("--rot", deg + "deg");
      kipGroup.style.setProperty("--rot", deg + "deg");
    }

    function advanceFullCW(){
      rotIndex  = (rotIndex + 1) % 4;
      faceIndex = (faceIndex + 1) % 3;
      setRotationSnap();
    }

    const slotTargetsW = [
      wFace.querySelector('[data-slot="S1"] .num > span'),
      wFace.querySelector('[data-slot="S2"] .num > span'),
      wFace.querySelector('[data-slot="S3"] .num > span'),
      wFace.querySelector('[data-slot="S4"] .num > span'),
    ];

    const slotTargetsKipRight = [
      kipGroup.querySelector('[data-slot="W1_1"] .num > span'),
      kipGroup.querySelector('[data-slot="W1_2"] .num > span'),
      kipGroup.querySelector('[data-slot="W1_3"] .num > span'),
      kipGroup.querySelector('[data-slot="W1_4"] .num > span'),
    ];

    const slotTargetsKipLeft = [
      kipGroup.querySelector('[data-slot="W2_A"] .num > span'),
      kipGroup.querySelector('[data-slot="W2_B"] .num > span'),
      kipGroup.querySelector('[data-slot="W2_C"] .num > span'),
      kipGroup.querySelector('[data-slot="W2_D"] .num > span'),
    ];

    function clearAllNumbers(){
      [...slotTargetsW, ...slotTargetsKipRight, ...slotTargetsKipLeft].forEach(s => { if(s) s.textContent = ""; });
    }

    function showW(){
      kipGroup.classList.add("hidden");
      wFace.classList.remove("hidden");
    }
    function showKip(){
      wFace.classList.add("hidden");
      kipGroup.classList.remove("hidden");
    }

    function renderWEmpty(){
      setRotationSnap();
      for(let i=0;i<4;i++) renderNumber(slotTargetsW[i], null);
    }

    function renderKipEmpty(){
      setRotationSnap();
      for(let i=0;i<4;i++){
        renderNumber(slotTargetsKipRight[i], null);
        renderNumber(slotTargetsKipLeft[i], null);
      }
    }

    function resetToW1Q0_Empty(){
      rotIndex = 0;
      faceIndex = 0;
      setRotationSnap();
      clearAllNumbers();
      showW();
      renderWEmpty();
    }

    let hasAdjustedOnce = false;

    let runningDemo     = false;
    let demoPaused      = false;
    let demoToken       = 0;

    let runningSet      = false;
    let setToken        = 0;

    function setAttentionSpeed(on){ kippspeedBlock.classList.toggle("attnSpeed", !!on); }
    function setAttentionPlay(on){  kippspeedBlock.classList.toggle("attnPlay", !!on); }
    function setAttentionSet(on){   kippspeedBlock.classList.toggle("attnSet", !!on); }

    function enterSpeedAttention(){
      setAttentionSet(false);
      setAttentionPlay(false);
      setAttentionSpeed(true);
    }
    function enterPlayAttention(){
      setAttentionSpeed(false);
      setAttentionPlay(true);
    }
    function enterSetAttention(){
      setAttentionSpeed(false);
      setAttentionPlay(false);
      setAttentionSet(true);
    }

    function setPlayGlyph(isPause){
      playGlyph.className = isPause ? "pauseIcon" : "playIcon";
    }

    function showSpeedMode(){
      speedMode.classList.remove("hidden");
      gameMode.classList.add("hidden");
      if(scorePanel) scorePanel.classList.add("hidden");
      if(previewHintEl) previewHintEl.classList.remove("hidden");
      enterSpeedAttention();
      setPlayGlyph(false);
    }

    function showGameMode(){
      speedMode.classList.add("hidden");
      gameMode.classList.remove("hidden");
      if(scorePanel) scorePanel.classList.remove("hidden");

      btnSetNumbers.classList.remove("hidden");
      decisionPanel.classList.add("hidden");
      levelPanel.classList.add("hidden");

      if(previewHintEl) previewHintEl.classList.remove("hidden");

      enterSetAttention();

      setPoints(0);
      gcHi.textContent = "80";
    }

    async function waitOrPause(ms, myToken){
      const slice = 40;
      let elapsed = 0;
      while(elapsed < ms){
        if(myToken !== demoToken) return false;
        if(demoPaused){
          await sleep(60);
          continue;
        }
        const step = Math.min(slice, ms - elapsed);
        await sleep(step);
        elapsed += step;
      }
      return (myToken === demoToken);
    }

    async function runDemoCycle(){
      if(runningDemo) return;
      runningDemo = true;
      demoPaused = false;
      const myToken = ++demoToken;

      const T = getTiming();

      showKip(); renderKipEmpty();
      if(!await waitOrPause(T.kipMs, myToken)) { runningDemo=false; return; }

      advanceFullCW(); showW(); renderWEmpty();
      if(!await waitOrPause(T.wMs, myToken)) { runningDemo=false; return; }

      showKip(); renderKipEmpty();
      if(!await waitOrPause(T.kipMs, myToken)) { runningDemo=false; return; }

      advanceFullCW(); showW(); renderWEmpty();
      if(!await waitOrPause(T.wMs, myToken)) { runningDemo=false; return; }

      showKip(); renderKipEmpty();
      if(!await waitOrPause(T.kipMs, myToken)) { runningDemo=false; return; }

      advanceFullCW(); showW(); renderWEmpty();
      if(!await waitOrPause(T.wMs, myToken)) { runningDemo=false; return; }

      showKip(); renderKipEmpty();
      if(!await waitOrPause(T.kipMs, myToken)) { runningDemo=false; return; }

      advanceFullCW(); showW(); renderWEmpty();
      if(!await waitOrPause(T.wMs, myToken)) { runningDemo=false; return; }

      runningDemo = false;
    }

    function cancelDemo(){
      demoToken++;
      runningDemo = false;
      demoPaused = false;
      setPlayGlyph(false);
    }

    let planned = [
      [null,null,null,null],
      [null,null,null,null],
      [null,null,null,null],
    ];
    let sets = [
      [null,null,null,null],
      [null,null,null,null],
      [null,null,null,null],
    ];
    let assigned = [false,false,false];

    function ensureAssigned(idx){
      if(assigned[idx]) return;
      sets[idx] = planned[idx].slice();
      assigned[idx] = true;
    }

    function renderW(){
      setRotationSnap();
      const curr = sets[faceIndex];
      for(let i=0;i<4;i++) renderNumber(slotTargetsW[i], curr[i]);
    }

    function mapHiddenToVisible_CW(face){
      const [f1,f2,f3,f4] = face;
      return [f4, f3, f2, f1];
    }

    function renderKip(){
      setRotationSnap();
      const curr = sets[faceIndex];
      const nextFaceIndex = (faceIndex + 1) % 3;
      const next = sets[nextFaceIndex];

      for(let i=0;i<4;i++) renderNumber(slotTargetsKipRight[i], curr[i]);
      const nextPreview = mapHiddenToVisible_CW(next);
      for(let i=0;i<4;i++) renderNumber(slotTargetsKipLeft[i], nextPreview[i]);
    }

    function reroll12_keepEmpty(){
      const twelve = getUniqueRandomNumbers(12, 1, 12);
      planned[0] = twelve.slice(0,4);
      planned[1] = twelve.slice(4,8);
      planned[2] = twelve.slice(8,12);

      sets = [
        [null,null,null,null],
        [null,null,null,null],
        [null,null,null,null],
      ];
      assigned = [false,false,false];

      rotIndex  = 0;
      faceIndex = 0;

      clearAllNumbers();
      setRotationSnap();
    }

    function beginLevelChoice(){
      btnSetNumbers.classList.add("hidden");
      decisionPanel.classList.add("hidden");
      levelPanel.classList.remove("hidden");

      if(previewHintEl) previewHintEl.classList.add("hidden");

      setAttentionSet(false);
      setAttentionPlay(false);
      setAttentionSpeed(false);

      levelTitle.textContent = "LEVEL WÄHLEN";
    }

    async function runSetNumbersCycle(){
      if(runningSet) return;
      runningSet = true;
      const myToken = ++setToken;

      reroll12_keepEmpty();

      const T = getTiming();

      showW(); renderWEmpty();
      await sleep(T.wMs);
      if(myToken!==setToken){ runningSet=false; return; }

      ensureAssigned(0); renderW();
      await sleep(T.wMs);
      if(myToken!==setToken){ runningSet=false; return; }

      showKip(); renderKip();
      await sleep(T.kipMs);
      if(myToken!==setToken){ runningSet=false; return; }

      advanceFullCW(); showW(); renderWEmpty();
      await sleep(T.wMs);
      if(myToken!==setToken){ runningSet=false; return; }

      ensureAssigned(1); renderW();
      await sleep(T.wMs);
      if(myToken!==setToken){ runningSet=false; return; }

      showKip(); renderKip();
      await sleep(T.kipMs);
      if(myToken!==setToken){ runningSet=false; return; }

      advanceFullCW(); showW(); renderWEmpty();
      await sleep(T.wMs);
      if(myToken!==setToken){ runningSet=false; return; }

      ensureAssigned(2); renderW();
      await sleep(T.wMs);
      if(myToken!==setToken){ runningSet=false; return; }

      showKip(); renderKip();
      await sleep(T.kipMs);
      if(myToken!==setToken){ runningSet=false; return; }

      advanceFullCW();
      showW();
      renderW();

      const EXTRA_KIPPS_AFTER_END = 3;

      await sleep(T.wMs);
      if(myToken!==setToken){ runningSet=false; return; }

      for(let j=0; j<EXTRA_KIPPS_AFTER_END; j++){
        showKip();
        renderKip();
        await sleep(T.kipMs);
        if(myToken!==setToken){ runningSet=false; return; }

        advanceFullCW();

        showW();
        renderW();
        await sleep(T.wMs);
        if(myToken!==setToken){ runningSet=false; return; }
      }

      runningSet = false;
      beginLevelChoice();
    }

    function cancelSetNumbers(){
      setToken++;
      runningSet = false;
    }

    function clearTargets(){
      Array.from(grid.querySelectorAll(".targetBadge")).forEach(el => el.remove());
    }

    function sideClassForCoord(coord){
      const r = parseInt(coord, 10);
      const c = coord.replace(String(r), "");
      if(r === 1) return "trot-top";
      if(r === 8) return "trot-bottom";
      if(c === "A") return "trot-left";
      if(c === "H") return "trot-right";
      return "trot-bottom";
    }

    /* ✅ Zielzahl muss auf allen 4 gleichfärbigen Zielfarbenfeldern sein. */
    function showTargetOnAllSameColor(colorClass, n){
      clearTargets();
      Array.from(grid.children).forEach(cell=>{
        if(!cell.classList.contains("colorCell")) return;
        if(!cell.classList.contains(colorClass)) return;

        const coord = cell.dataset.coord;
        const badge = document.createElement("div");
        badge.className = "targetBadge " + sideClassForCoord(coord);
        badge.textContent = String(n);
        cell.appendChild(badge);
      });
    }

    function colorRgbForClass(colorClass){
      if(colorClass === "c-orange")  return getComputedStyle(document.documentElement).getPropertyValue("--orange").trim();
      if(colorClass === "c-gruen")   return getComputedStyle(document.documentElement).getPropertyValue("--gruen").trim();
      if(colorClass === "c-violett") return getComputedStyle(document.documentElement).getPropertyValue("--violett").trim();
      if(colorClass === "c-blau")    return getComputedStyle(document.documentElement).getPropertyValue("--blau").trim();
      return getComputedStyle(document.documentElement).getPropertyValue("--ui-text").trim();
    }

    /* ===== Spielregeln ===== */
    const MAX_ROUNDS = 10;
    const MAX_TRIES  = 3;
    const SCORE_BY_TRY = [8,5,3];

    let roundIndex = 0;
    let tryIndex   = 0;
    let points     = 0;

    // ✅ Ziel ist (Zielfarbe, ZielNumber)
    let currentTargetColor = null;
    let currentTargetNumber = null;

    function setPoints(p){
      points = Math.max(0, p|0);
      const s = String(points).padStart(2, "0");
      gcPoints.textContent = "P" + s + "/80";
    }

    // ===== Koordinaten-Helfer (Rotation) =====
    const colToX = {A:1,B:2,C:3,D:4,E:5,F:6,G:7,H:8};
    const xToCol = ["","A","B","C","D","E","F","G","H"];

    function parseCoord(coord){
      const r = parseInt(coord, 10);
      const c = coord.replace(String(r), "");
      return { x: colToX[c], y: r };
    }
    function makeCoord(x,y){
      return `${y}${xToCol[x]}`;
    }
    // Rotation CW um Zentrum (4.5,4.5): (x,y) -> (y, 9-x)
    function rotateCoordCW(coord, times){
      let {x,y} = parseCoord(coord);
      let t = ((times%4)+4)%4;
      for(let i=0;i<t;i++){
        const nx = y;
        const ny = 9 - x;
        x = nx; y = ny;
      }
      return makeCoord(x,y);
    }

    // ===== Unsere 4 sichtbaren Slot-Positionen bei rotIndex=0 =====
    const BASE_SLOT_COORDS = ["3B","4B","2C","2D"]; // Reihenfolge passt zu curr[0..3] und S1..S4

    function currentInnerMap(){
      const curr = sets[faceIndex] || [];
      const map = new Map();
      for(let i=0;i<4;i++){
        const base = BASE_SLOT_COORDS[i];
        const abs  = rotateCoordCW(base, rotIndex);
        const n    = curr[i];
        if(n != null) map.set(abs, n);
      }
      return map;
    }

    // ===== Ziel-Felder (außen) =====
    const TARGET_COORDS = [
      "3A","4A","5A","6A",
      "3H","4H","5H","6H",
      "1C","1D","1E","1F",
      "8C","8D","8E","8F",
    ];

    function adjacentInnerCoordForTarget(targetCoord){
      const {x,y} = parseCoord(targetCoord);
      // außen -> innen direkt daneben:
      if(x === 1) return makeCoord(2, y);      // A -> B
      if(x === 8) return makeCoord(7, y);      // H -> G
      if(y === 1) return makeCoord(x, 2);      // 1 -> 2
      if(y === 8) return makeCoord(x, 7);      // 8 -> 7
      return null;
    }

    // ===== Quadrant-Logik (Q0..Q3) =====
    // ✅ Quadrant ist bei dir rotIndex (0..3)
    function getCubeQuadrant(){
      return rotIndex; // 0=Q0, 1=Q1, 2=Q2, 3=Q3
    }

    // Quadrant eines Koordinatenpunkts relativ zum Zentrum (4.5,4.5)
    // Q0: oben-links, Q1: oben-rechts, Q2: unten-rechts, Q3: unten-links
    function quadrantOfCoord(coord){
      const {x,y} = parseCoord(coord);
      const left  = (x <= 4);
      const top   = (y <= 4);
      if(top && left) return 0;
      if(top && !left) return 1;
      if(!top && !left) return 2;
      return 3;
    }

    // ✅ Feldnummern pro Quadrant (deine fixe FI-Definition)
    // Q0: F1=4A, F2=3A, F3=1C, F4=1D
    // Q1: F1=1E, F2=1F, F3=3H, F4=4H
    // Q2: F1=5H, F2=6H, F3=8F, F4=8E
    // Q3: F1=8D, F2=8C, F3=6A, F4=5A
    const QUAD_FIELD_COORDS = {
      0: {1:"4A", 2:"3A", 3:"1C", 4:"1D"},
      1: {1:"1E", 2:"1F", 3:"3H", 4:"4H"},
      2: {1:"5H", 2:"6H", 3:"8F", 4:"8E"},
      3: {1:"8D", 2:"8C", 3:"6A", 4:"5A"},
    };

    function fieldIdForTargetCoord(coord, quad){
      const q = QUAD_FIELD_COORDS[quad];
      if(!q) return null;
      for(const fid of [1,2,3,4]){
        if(q[fid] === coord) return fid;
      }
      return null;
    }

    function slotIdAtInnerCoord(innerCoord){
      // SlotId ergibt sich aus BASE_SLOT_COORDS + Rotation
      for(let i=0;i<4;i++){
        const abs = rotateCoordCW(BASE_SLOT_COORDS[i], rotIndex);
        if(abs === innerCoord) return (i+1); // S1..S4
      }
      return null;
    }

    function ordinalDeTitle(k){
      const map = [
        "Erstes","Zweites","Drittes","Viertes","Fünftes",
        "Sechstes","Siebentes","Achtes","Neuntes","Zehntes"
      ];
      if(k >= 1 && k <= 10) return map[k-1];
      return "Nächstes";
    }

    function setGoalInfoText(roundOneBased){
      const ord = ordinalDeTitle(roundOneBased);
      const rgb = colorRgbForClass(currentTargetColor);
      kippTitleEl.innerHTML = `${ord} <span class="kippGoalWord" style="color:${rgb};">KIPP-ZIEL</span> (von zehn)`;
      kippStatusEl.textContent = "Wähle deine KIPP Anzahl";
    }

    function setTryText(){
      if(tryIndex === 0){
        kippTitleEl.textContent  = "KIPP Anzahl wählen";
        kippStatusEl.textContent = "Tippe auf eine Taste";
      }else if(tryIndex === 1){
        kippTitleEl.textContent  = "ZWEITER VERSUCH";
        kippStatusEl.textContent = "KIPPANZAHL WÄHLEN";
      }else{
        kippTitleEl.textContent  = "LETZTER VERSUCH";
        kippStatusEl.textContent = "KIPPANZAHL WÄHLEN";
      }
    }

    function startPulse(){ decisionPanel.classList.add("pulseSeq"); }
    function stopPulse(){ decisionPanel.classList.remove("pulseSeq"); }

    let selectedKippCount = null;

    function setButtonsEnabled(enabled){
      document.querySelectorAll('.miniBtn[data-k]').forEach(btn=>{
        btn.disabled = !enabled;
      });
    }

    function selectKippCount(k){
      selectedKippCount = (k == null) ? null : Number(k);
      document.querySelectorAll('.miniBtn[data-k]').forEach(btn=>{
        btn.classList.toggle("sel", Number(btn.dataset.k) === selectedKippCount);
      });
      if(selectedKippCount != null) stopPulse();
    }

    let busyMove = false;

    /* =========================
       ✅ Trefferprüfung nach deiner FI/SI-Regel (robust gegen doppelte Zielfarben)
       Treffer, wenn:
       - Im aktuellen Quadranten (rotIndex) gibt es ein Zielfeld in Zielfarbe,
       - an dessen INNER-Adjazenz ein Slot liegt,
       - dort steht die Zielzahl,
       - und SlotID == FeldID (S1=F1, S2=F2, S3=F3, S4=F4).
       ========================= */
    function isHitForTarget(inner, targetColor, targetNumber){
      const quad = getCubeQuadrant();

      // Kandidaten: alle Zielfelder dieser Farbe im aktuellen Quadranten
      const candidates = TARGET_COORDS
        .filter(tc => colorMap.get(tc) === targetColor)
        .filter(tc => quadrantOfCoord(tc) === quad);

      for(const tc of candidates){
        const fid = fieldIdForTargetCoord(tc, quad);
        if(fid == null) continue;

        const adj = adjacentInnerCoordForTarget(tc);
        if(!adj) continue;

        const sid = slotIdAtInnerCoord(adj);
        if(sid == null) continue;

        if(sid !== fid) continue; // ✅ FI muss SI sein

        if(inner.get(adj) === targetNumber) return true;
      }
      return false;
    }

    function pickNewTarget(){
      const inner = currentInnerMap();
      const visibleNums = Array.from(new Set(Array.from(inner.values())));

      // Fallback
      if(visibleNums.length === 0){
        currentTargetColor = "c-orange";
        currentTargetNumber = 1;
        showTargetOnAllSameColor(currentTargetColor, currentTargetNumber);
        return;
      }

      const allColors = Array.from(new Set(TARGET_COORDS.map(tc=>colorMap.get(tc)).filter(Boolean)));

      // Pick (Farbe, Zahl) so, dass es NICHT sofort ein Treffer ist
      let guard = 0;
      while(guard < 200){
        const col = allColors[Math.floor(Math.random()*allColors.length)] || "c-orange";
        const n   = visibleNums[Math.floor(Math.random()*visibleNums.length)];
        const hitNow = isHitForTarget(inner, col, n);
        if(!hitNow){
          currentTargetColor = col;
          currentTargetNumber = n;
          showTargetOnAllSameColor(currentTargetColor, currentTargetNumber);
          return;
        }
        guard++;
      }

      currentTargetColor = allColors[Math.floor(Math.random()*allColors.length)] || "c-orange";
      currentTargetNumber = visibleNums[Math.floor(Math.random()*visibleNums.length)];
      showTargetOnAllSameColor(currentTargetColor, currentTargetNumber);
    }

    function evaluateHit(){
      if(!currentTargetColor || currentTargetNumber == null) return false;
      const inner = currentInnerMap();
      return isHitForTarget(inner, currentTargetColor, currentTargetNumber);
    }

    async function performKippCW(count){
      if(busyMove) return;
      if(!count) return;

      busyMove = true;
      setButtonsEnabled(false);

      const c = Math.max(1, Math.min(9, Number(count)));
      const T = getTiming();

      for(let i=0; i<c; i++){
        showKip();
        renderKip();
        await sleep(T.kipMs);

        advanceFullCW();

        showW();
        renderW();
        await sleep(T.wMs);
      }

      const hit = evaluateHit();

      if(hit){
        const add = SCORE_BY_TRY[Math.min(tryIndex, SCORE_BY_TRY.length-1)] || 0;
        setPoints(points + add);

        roundIndex++;
        tryIndex = 0;

        if(roundIndex >= MAX_ROUNDS){
          clearTargets();
          alert("ENDE! Punkte: " + points);
          showSpeedMode();
          busyMove = false;
          setButtonsEnabled(true);
          return;
        }

        pickNewTarget();
        setGoalInfoText(roundIndex + 1);

      }else{
        tryIndex++;

        if(tryIndex >= MAX_TRIES){
          roundIndex++;
          tryIndex = 0;

          if(roundIndex >= MAX_ROUNDS){
            clearTargets();
            alert("ENDE! Punkte: " + points);
            showSpeedMode();
            busyMove = false;
            setButtonsEnabled(true);
            return;
          }

          pickNewTarget();
          setGoalInfoText(roundIndex + 1);
        }
      }

      selectKippCount(null);
      setTryText();
      startPulse();
      setButtonsEnabled(true);

      busyMove = false;
    }

    document.querySelectorAll('.miniBtn[data-k]').forEach(btn=>{
      btn.addEventListener("click", () => {
        if(busyMove) return;
        selectKippCount(btn.dataset.k);
        performKippCW(selectedKippCount);
      });
    });

    function beginPlayerPhase(){
      levelPanel.classList.add("hidden");
      btnSetNumbers.classList.add("hidden");
      decisionPanel.classList.remove("hidden");
      enterSetAttention();

      roundIndex = 0;
      tryIndex = 0;
      setPoints(points);

      pickNewTarget();
      setTryText();

      selectKippCount(null);
      startPulse();
      setButtonsEnabled(true);

      setGoalInfoText(1);
      setTryText();
    }

    speedSlider.addEventListener("input", () => {
      hasAdjustedOnce = true;
      if(!runningDemo) enterPlayAttention();
    });

    btnPlay.addEventListener("click", async () => {
      if(!hasAdjustedOnce) enterPlayAttention();

      if(!runningDemo){
        setAttentionPlay(false);
        setPlayGlyph(true);
        await runDemoCycle();
        setPlayGlyph(false);
        enterPlayAttention();
        return;
      }

      demoPaused = !demoPaused;
      setPlayGlyph(demoPaused ? false : true);
    });

    btnOk.addEventListener("click", () => {
      cancelDemo();
      cancelSetNumbers();
      resetToW1Q0_Empty();
      setAttentionPlay(false);
      setAttentionSpeed(false);
      showGameMode();
    });

    btnSetNumbers.addEventListener("click", async () => {
      setAttentionSet(false);
      if(previewHintEl) previewHintEl.classList.remove("hidden");
      await runSetNumbersCycle();
    });

    backBtn.addEventListener("click", () => {
      cancelDemo();
      cancelSetNumbers();
      busyMove = false;
      clearTargets();

      levelPanel.classList.add("hidden");
      decisionPanel.classList.add("hidden");

      resetToW1Q0_Empty();
      showSpeedMode();
    });

    exitBtnTop.addEventListener("click", () => {
      const ok = confirm("Spiel wirklich beenden?");
      if(ok){
        window.location.href = "about:blank";
      }
    });

    btnLevelTrainee.addEventListener("click", () => { if(busyMove) return; beginPlayerPhase(); });
    btnLevelBrainy.addEventListener("click", () => { if(busyMove) return; beginPlayerPhase(); });
    btnLevelBrain.addEventListener("click", () => { if(busyMove) return; beginPlayerPhase(); });

    if(btnKippBilanz){
      btnKippBilanz.addEventListener("click", () => {
        alert("KIPP Bilanz (noch ohne Funktion)");
      });
    }

    window.addEventListener("load", () => {
      setBoardSquare();
      requestAnimationFrame(setBoardSquare);
      setTimeout(setBoardSquare, 80);

      buildGridOnce();

      setKippspeedStripHeight();
      requestAnimationFrame(setKippspeedStripHeight);
      setTimeout(setKippspeedStripHeight, 80);

      resetToW1Q0_Empty();
      showSpeedMode();
    });

    window.addEventListener("resize", () => {
      setBoardSquare();
      requestAnimationFrame(setBoardSquare);

      setKippspeedStripHeight();
      requestAnimationFrame(setKippspeedStripHeight);
    });
  </script>
</body>
</html>
